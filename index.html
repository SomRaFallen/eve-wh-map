<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>WH Map</title>
<style>
  body { font-family: Arial; margin:0; display:flex; height:100vh; }
  #mapContainer { flex:1; position:relative; background:#111; }
  svg { position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; }
  .system { position:absolute; width:120px; height:50px; background:#444; color:#fff; border-radius:10px; text-align:center; cursor:pointer; display:flex; flex-direction:column; justify-content:center; user-select:none; padding:2px; }
  .system.home { border:2px solid yellow; }
  #sidebar { width:300px; background:#222; color:#fff; padding:10px; overflow:auto; }
  input, select, button { margin:3px 0; width:100%; }
  .connection { stroke:#0f0; stroke-width:2; }
</style>
</head>
<body>

<div id="mapContainer">
  <svg id="connectionsLayer"></svg>
</div>

<div id="sidebar">
  <input id="newSystem" placeholder="Введите номер системы" />
  <button onclick="addSystem()">Добавить систему</button>
  <hr>
  <div id="systemInfo">Выберите систему</div>
  <button onclick="deleteSystem()">Удалить систему</button>
  <hr>
  <button onclick="makeHome()">Сделать домашней</button>
  <button onclick="openZKB()">Открыть ZKB</button>
  <button onclick="openEveOK()">Открыть EveOK</button>
  <hr>
  <label>Класс WH:</label>
  <input id="sysClass" oninput="updateSystem()" />
  <label>Эффекты:</label>
  <input id="sysEffects" oninput="updateSystem()" />
  <label>Статики:</label>
  <input id="sysStatics" oninput="updateSystem()" />
</div>

<script>
let systems = [];
let selectedSystem = null;
let dragging = null;
let offsetX=0, offsetY=0;
let connectFrom = null;

const mapContainer = document.getElementById('mapContainer');
const connectionsLayer = document.getElementById('connectionsLayer');
const systemInfo = document.getElementById('systemInfo');
const sysClass = document.getElementById('sysClass');
const sysEffects = document.getElementById('sysEffects');
const sysStatics = document.getElementById('sysStatics');

// загрузка из localStorage
if(localStorage.getItem('systems')){
  systems = JSON.parse(localStorage.getItem('systems'));
  renderSystems();
}

function saveSystems(){ 
  localStorage.setItem('systems', JSON.stringify(systems));
}

function addSystem(){
  const input = document.getElementById('newSystem').value.trim();
  if(!input) return;
  let sysName = input.toUpperCase();
  if(!sysName.startsWith('J')) sysName = 'J'+sysName;

  const sys = {
    name: sysName,
    class: '',
    effects: '',
    statics: '',
    home:false,
    x:50 + systems.length*20,
    y:50 + systems.length*20,
    connections:[]
  };
  systems.push(sys);
  saveSystems();
  renderSystems();
  selectSystem(sys);
}

function renderSystems(){
  mapContainer.querySelectorAll('.system').forEach(el=>el.remove());
  systems.forEach(sys=>{
    const div = document.createElement('div');
    div.className = 'system'+(sys.home?' home':'');
    div.style.left = sys.x+'px';
    div.style.top = sys.y+'px';
    div.innerHTML = `<b>${sys.name}</b><br>${sys.class}`;

    div.onmousedown = e=>{
      dragging = sys;
      offsetX = e.clientX - sys.x;
      offsetY = e.clientY - sys.y;
      selectSystem(sys);
    };
    div.ondblclick = ()=>connectMode(sys);
    mapContainer.appendChild(div);
  });
  renderConnections();
}

document.addEventListener('mouseup', ()=>dragging=null);
document.addEventListener('mousemove', e=>{
  if(dragging){
    dragging.x = e.clientX - offsetX;
    dragging.y = e.clientY - offsetY;
    renderSystems();
    saveSystems();
  }
});

function selectSystem(sys){
  selectedSystem = sys;
  systemInfo.innerHTML = `<b>${sys.name}</b>`;
  sysClass.value = sys.class;
  sysEffects.value = sys.effects;
  sysStatics.value = sys.statics;
}

function updateSystem(){
  if(!selectedSystem) return;
  selectedSystem.class = sysClass.value;
  selectedSystem.effects = sysEffects.value;
  selectedSystem.statics = sysStatics.value;
  renderSystems();
  saveSystems();
}

function deleteSystem(){
  if(!selectedSystem) return;
  systems = systems.filter(s=>s!==selectedSystem);
  systems.forEach(s=>s.connections = s.connections.filter(c=>c!==selectedSystem.name));
  selectedSystem = null;
  saveSystems();
  renderSystems();
  systemInfo.innerHTML = 'Выберите систему';
}

// ----------------- Buttons -----------------
function makeHome(){
  if(!selectedSystem) return;
  systems.forEach(s=>s.home=false);
  selectedSystem.home = true;
  renderSystems();
  saveSystems();
}

function openZKB(){
  if(!selectedSystem) return;
  window.open(`https://zkillboard.com/system/${selectedSystem.name}/`, '_blank');
}

function openEveOK(){
  if(!selectedSystem) return;
  window.open(`https://eveok.ru/wh/${selectedSystem.name}`, '_blank');
}

// ---------------- Connections -----------------
function connectMode(sys){
  if(!connectFrom) {
    connectFrom = sys;
    alert('Выберите систему для соединения с '+sys.name);
  } else {
    if(connectFrom!==sys){
      if(!connectFrom.connections.includes(sys.name)) connectFrom.connections.push(sys.name);
      if(!sys.connections.includes(connectFrom.name)) sys.connections.push(connectFrom.name);
      connectFrom = null;
      renderConnections();
      saveSystems();
    }
  }
}

function renderConnections(){
  connectionsLayer.innerHTML='';
  systems.forEach(sys=>{
    sys.connections.forEach(conn=>{
      const target = systems.find(s=>s.name===conn);
      if(target){
        const line = document.createElementNS("http://www.w3.org/2000/svg",'line');
        line.setAttribute('x1', sys.x+60);
        line.setAttribute('y1', sys.y+25);
        line.setAttribute('x2', target.x+60);
        line.setAttribute('y2', target.y+25);
        line.classList.add('connection');
        connectionsLayer.appendChild(line);
      }
    });
  });
}
</script>
</body>
</html>
