<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EVE — Карта перемещений пилота</title>
<script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:16px}
button{font-size:1rem;padding:8px;margin:4px}
#map{width:100%;height:420px;border:1px solid #ddd;margin-top:12px}
#results{margin-top:12px}
.note{color:#555;font-size:0.9rem}
</style>
</head>
<body>
<h2>EVE Online — Карта перемещений пилота</h2>
<p class="note">Сайт использует <strong>EVE SSO</strong> и строит карту последних посещённых систем пилота.</p>

<div>
<button id="authBtn">Авторизоваться через EVE Online</button>
<button id="logoutBtn" style="display:none">Выйти</button>
</div>
<div id="authInfo" class="note"></div>
<div>
<button id="buildMapBtn" style="display:none">Построить карту перемещений</button>
</div>

<div id="status" class="note"></div>
<div id="map"></div>
<div id="results"></div>

<script>
const CLIENT_ID = '5a40c55151c241e3a007f2562fd4e1dd';
const REDIRECT_URI = window.location.origin + window.location.pathname;
const SCOPES = 'esi-location.read_location.v1';
const ESI_BASE = 'https://esi.evetech.net/latest';
const PROXY_URL = 'https://eve-proxy.onrender.com/exchange';

const authBtn = document.getElementById('authBtn');
const logoutBtn = document.getElementById('logoutBtn');
const authInfo = document.getElementById('authInfo');
const buildMapBtn = document.getElementById('buildMapBtn');
const status = document.getElementById('status');
const results = document.getElementById('results');
const container = document.getElementById('map');

function login(){
    const state = Math.random().toString(36).substring(2);
    const url = `https://login.eveonline.com/v2/oauth/authorize?response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&client_id=${CLIENT_ID}&scope=${encodeURIComponent(SCOPES)}&state=${state}`;
    window.location.href = url;
}

async function exchangeCodeForToken(code){
    const r = await fetch(PROXY_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ code })
    });
    if(!r.ok) throw new Error('Ошибка обмена кода на токен');
    return await r.json();
}

async function getCharacterInfo(token){
    const r = await fetch('https://esi.evetech.net/verify/',{headers:{Authorization:`Bearer ${token}`}});
    if(!r.ok) throw new Error('Ошибка проверки токена');
    return await r.json();
}

function logout(){
    localStorage.removeItem('eve_token');
    localStorage.removeItem('eve_char');
    authInfo.textContent = '';
    authBtn.style.display = 'inline-block';
    logoutBtn.style.display = 'none';
    buildMapBtn.style.display = 'none';
}

async function handleAuth(){
    const params = new URLSearchParams(window.location.search);
    if(params.has('code')){
        const code = params.get('code');
        try{
            const tokenData = await exchangeCodeForToken(code);
            const verify = await getCharacterInfo(tokenData.access_token);
            localStorage.setItem('eve_token', tokenData.access_token);
            localStorage.setItem('eve_char', JSON.stringify(verify));
            authInfo.textContent = `Авторизован: ${verify.CharacterName} (ID: ${verify.CharacterID})`;
            authBtn.style.display = 'none';
            logoutBtn.style.display = 'inline-block';
            buildMapBtn.style.display = 'inline-block';
            window.history.replaceState({}, document.title, window.location.pathname);
        }catch(e){
            console.error(e);
            authInfo.textContent = 'Ошибка авторизации: '+e.message;
        }
    } else {
        const token = localStorage.getItem('eve_token');
        const char = localStorage.getItem('eve_char');
        if(token && char){
            const c = JSON.parse(char);
            authInfo.textContent = `Авторизован: ${c.CharacterName} (ID: ${c.CharacterID})`;
            authBtn.style.display = 'none';
            logoutBtn.style.display = 'inline-block';
            buildMapBtn.style.display = 'inline-block';
        }
    }
}

authBtn.addEventListener('click', login);
logoutBtn.addEventListener('click', logout);
handleAuth();

async function esiGetCurrentLocation(character_id, token){
    const url = `${ESI_BASE}/v2/characters/${character_id}/location/`;
    const r = await fetch(url,{headers:{Authorization:`Bearer ${token}`}});
    if(r.status===404) return null;
    if(!r.ok) throw new Error('Ошибка получения локации: '+r.status);
    return await r.json();
}

async function esiGetSystem(system_id){
    const url = `${ESI_BASE}/v4/universe/systems/${system_id}/`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('Ошибка получения системы: '+r.status);
    return await r.json();
}

function isWormholeSystemName(name){ return /^J\d+/i.test(name); }

function drawNetwork(nodesArr, edgesArr){
    const nodes = new vis.DataSet(nodesArr.map((n,i)=>({id:i,label:n})));
    const edges = new vis.DataSet(edgesArr.map(e=>({from:e.from,to:e.to})));
    const data = { nodes, edges };
    const options = { physics:{stabilization:true, barnesHut:{gravitationalConstant:-8000}} };
    new vis.Network(container, data, options);
}

// Для примера: имитация истории последних перемещений
function getFakeHistorySystems(){
    return [
        {id:30000142,name:'Jita'}, 
        {id:30000144,name:'Perimeter'},
        {id:30000142,name:'Jita'},
        {id:30002187,name:'Amarr'},
        {id:30000144,name:'Perimeter'}
    ];
}

buildMapBtn.addEventListener('click', async ()=>{
    results.innerHTML = '';
    container.innerHTML = '';
    const token = localStorage.getItem('eve_token');
    const char = JSON.parse(localStorage.getItem('eve_char'));
    const charName = char.CharacterName;

    try{
        status.textContent = 'Получаем историю перемещений...';

        // Для теста используем фиктивную историю
        const history = getFakeHistorySystems();

        // Создаем уникальные узлы и связи по порядку
        const nodesSet = new Set();
        const edges = [];
        const nodes = [];
        nodes.push(charName); // главный узел
        let lastNode = 0;
        history.forEach((s, idx)=>{
            if(!nodesSet.has(s.name)){
                nodesSet.add(s.name);
                nodes.push(s.name);
            }
            const nodeIndex = nodes.indexOf(s.name);
            edges.push({from:lastNode,to:nodeIndex});
            lastNode = nodeIndex;
        });

        drawNetwork(nodes, edges);

        // Вывод истории
        const html = [];
        html.push('<h3>История перемещений:</h3><ul>');
        history.forEach(s=>{
            const flag = isWormholeSystemName(s.name)? ' — ВХ':'';
            html.push(`<li>${s.name}${flag}</li>`);
        });
        html.push('</ul>');
        results.innerHTML = html.join('');
        status.textContent='Готово';
    }catch(e){
        console.error(e);
        status.textContent='Ошибка: '+e.message;
    }
});
</script>
</body>
</html>
