<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EVE WH Map</title>
<script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
<style>
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:16px; }
button { font-size: 1rem; padding:6px; margin:4px; }
#map { width:100%; height:500px; border:1px solid #ddd; margin-top:12px; }
#info { margin-top:12px; }
.note { color:#555; font-size:0.9rem; }
</style>
</head>
<body>
<h2>EVE Online — Карта перемещений WH</h2>
<p class="note">Сохраняйте свои перемещения через вормхолы, редактируйте маршрут, просматривайте информацию о системах.</p>

<div>
  <button id="authBtn">Авторизоваться через EVE Online</button>
  <button id="logoutBtn" style="display:none">Выйти</button>
</div>

<div id="authInfo" class="note"></div>

<div>
  <button id="saveBtn" style="display:none">Сохранить текущую систему</button>
  <button id="clearBtn" style="display:none">Очистить маршрут</button>
  <button id="refreshBtn" style="display:none">Обновить карту</button>
</div>

<div id="map"></div>
<div id="info"></div>

<script>
const CLIENT_ID = '5a40c55151c241e3a007f2562fd4e1dd';
const REDIRECT_URI = 'https://somrafallen.github.io/eve-wh-map/'; // должен точно совпадать с приложением EVE Online
const SCOPES = 'esi-location.read_location.v1';
const SERVER = 'https://eve-api.onrender.com'; // твой сервер на Render (HTTPS)

let charData = null;
let historyData = [];
let network = null;

const authBtn = document.getElementById('authBtn');
const logoutBtn = document.getElementById('logoutBtn');
const authInfo = document.getElementById('authInfo');
const saveBtn = document.getElementById('saveBtn');
const clearBtn = document.getElementById('clearBtn');
const refreshBtn = document.getElementById('refreshBtn');
const infoDiv = document.getElementById('info');
const container = document.getElementById('map');

function login(){
  const state = Math.random().toString(36).substring(2);
  window.location.href = `https://login.eveonline.com/v2/oauth/authorize?response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&client_id=${CLIENT_ID}&scope=${encodeURIComponent(SCOPES)}&state=${state}`;
}

async function exchangeCode(code){
  // fetch на сервер Render, который обменивает код на токен
  const r = await fetch(`${SERVER}/exchange`, {
    method:'POST',
    headers:{'Content-Type':'application/json; charset=utf-8'},
    body: JSON.stringify({code})
  });
  if(!r.ok) throw new Error('Ошибка обмена кода');
  return await r.json();
}

async function getCharacterInfo(token){
  const r = await fetch('https://esi.evetech.net/verify/', {
    headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/json; charset=utf-8'}
  });
  if(!r.ok) throw new Error('Ошибка проверки токена');
  return await r.json();
}

function logout(){
  localStorage.removeItem('eve_token');
  localStorage.removeItem('eve_char');
  charData = null;
  authInfo.textContent = '';
  authBtn.style.display = 'inline-block';
  logoutBtn.style.display = 'none';
  saveBtn.style.display = 'none';
  clearBtn.style.display = 'none';
  refreshBtn.style.display = 'none';
}

async function handleAuth(){
  const params = new URLSearchParams(window.location.search);
  if(params.has('code')){
    const code = params.get('code');
    try{
      const tokenData = await exchangeCode(code);
      const token = tokenData.access_token;
      charData = await getCharacterInfo(token);
      localStorage.setItem('eve_token', token);
      localStorage.setItem('eve_char', JSON.stringify(charData));
      showAuth();
      window.history.replaceState({}, document.title, window.location.pathname);
    } catch(e){
      console.error(e);
      authInfo.textContent = 'Ошибка авторизации: '+e.message;
    }
  } else {
    const savedChar = localStorage.getItem('eve_char');
    if(savedChar){
      charData = JSON.parse(savedChar);
      showAuth();
    }
  }
}

function showAuth(){
  authInfo.textContent = `Авторизован: ${charData.CharacterName} (ID: ${charData.CharacterID})`;
  authBtn.style.display = 'none';
  logoutBtn.style.display = 'inline-block';
  saveBtn.style.display = 'inline-block';
  clearBtn.style.display = 'inline-block';
  refreshBtn.style.display = 'inline-block';
  loadHistory();
}

async function loadHistory(){
  if(!charData) return;
  const r = await fetch(`${SERVER}/history/${charData.CharacterID}`);
  historyData = await r.json();
  buildMap();
}

function buildMap(){
  const nodes = historyData.map((h,i)=>({id:i,label:h.systemName, title:`Система: ${h.systemName}`}));
  const edges = historyData.map((h,i)=>i>0?{from:i-1,to:i}:null).filter(e=>e);
  const data = {nodes,edges};
  const options = {physics:{enabled:true}, interaction:{hover:true, multiselect:true}};
  if(network) network.destroy();
  network = new vis.Network(container, data, options);
  network.on('selectNode', params=>{
    const node = historyData[params.nodes[0]];
    infoDiv.textContent = `Система: ${node.systemName} | Время сохранения: ${node.timestamp}`;
    // позже можно добавить информацию о сооружениях через ESI
  });
}

async function saveCurrentSystem(){
  if(!charData) return alert('Не авторизован');
  const systemName = prompt('Введите название текущей системы:');
  if(!systemName) return;
  const systemID = Math.floor(Math.random()*100000); // позже заменить на реальные systemID через ESI
  const r = await fetch(`${SERVER}/location`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({characterID:charData.CharacterID, systemID, systemName})
  });
  const data = await r.json();
  console.log(data);
  await loadHistory();
}

async function clearHistory(){
  if(!charData) return alert('Не авторизован');
  await fetch(`${SERVER}/history/${charData.CharacterID}`, {method:'DELETE'});
  await loadHistory();
}

authBtn.addEventListener('click', login);
logoutBtn.addEventListener('click', logout);
saveBtn.addEventListener('click', saveCurrentSystem);
clearBtn.addEventListener('click', clearHistory);
refreshBtn.addEventListener('click', loadHistory);

handleAuth();
</script>
</body>
</html>
