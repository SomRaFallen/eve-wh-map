<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>WH Map</title>
<style>
  body { font-family: Arial; margin:0; overflow:hidden; }
  #map { position: relative; width: 100vw; height: 100vh; background: #111; }
  .system {
    position: absolute;
    width: 120px;
    height: 50px;
    background: #333;
    color: #fff;
    text-align: center;
    line-height: 50px;
    border-radius: 10px;
    cursor: grab;
    user-select: none;
  }
  .system.home { border: 2px solid gold; }
  #connections { position:absolute; width:100%; height:100%; pointer-events:none; }
  #info { position: absolute; top: 10px; right: 10px; width: 250px; background:#222; color:#fff; padding:10px; border-radius:8px; font-size:14px; }
  .buttons { position: absolute; top: 10px; left: 10px; z-index: 10; }
  .buttons button { margin-right: 5px; padding: 5px 10px; }
</style>
</head>
<body>

<div id="map">
  <div class="buttons">
    <button onclick="addSystem()">Добавить систему</button>
    <button onclick="clearAll()">Очистить карту</button>
  </div>
  <svg id="connections"></svg>
</div>

<div id="info">Информация о системе</div>

<script>
let systems = [];
let selectedSystem = null;
let dragSystem = null;
let offsetX, offsetY;

function addSystem() {
  const name = prompt("Введите номер системы:", "114337");
  if(!name) return;
  const systemName = name.startsWith('J') ? name : 'J' + name;
  const sys = { id: systems.length+1, name: systemName, x:100, y:100, connections:[], home:false, class:'', effects:'', statics:'' };
  systems.push(sys);
  fetchSystemInfo(sys);
  renderSystems();
}

function clearAll() {
  systems = [];
  renderSystems();
  document.getElementById('info').innerHTML = 'Информация о системе';
}

function renderSystems(){
  const map = document.getElementById('map');
  const svg = document.getElementById('connections');

  // Очистка старых элементов
  svg.innerHTML = '';
  Array.from(map.querySelectorAll('.system')).forEach(e=>e.remove());

  // Рисуем соединения
  systems.forEach(s=>{
    s.connections.forEach(cId=>{
      const target = systems.find(t=>t.id===cId);
      if(!target) return;
      const line = document.createElementNS("http://www.w3.org/2000/svg","line");
      line.setAttribute('x1', s.x+60);
      line.setAttribute('y1', s.y+25);
      line.setAttribute('x2', target.x+60);
      line.setAttribute('y2', target.y+25);
      line.setAttribute('stroke','#888');
      line.setAttribute('stroke-width','2');
      svg.appendChild(line);
    });
  });

  // Рисуем системы
  systems.forEach(s=>{
    const div = document.createElement('div');
    div.className = 'system' + (s.home?' home':'');
    div.style.left = s.x+'px';
    div.style.top = s.y+'px';
    div.textContent = s.name;
    div.onmousedown = startDrag.bind(null,s);
    div.onclick = () => selectSystem(s);
    map.appendChild(div);
  });
}

function startDrag(sys, e) {
  dragSystem = sys;
  offsetX = e.offsetX;
  offsetY = e.offsetY;
  document.onmousemove = doDrag;
  document.onmouseup = stopDrag;
}

function doDrag(e) {
  if(!dragSystem) return;
  dragSystem.x = e.clientX - offsetX;
  dragSystem.y = e.clientY - offsetY;
  renderSystems();
}

function stopDrag() {
  dragSystem = null;
  document.onmousemove = null;
  document.onmouseup = null;
}

function selectSystem(sys){
  selectedSystem = sys;
  const infoDiv = document.getElementById('info');
  infoDiv.innerHTML = `
    <b>${sys.name}</b><br>
    Класс: ${sys.class || '...'}<br>
    Эффекты: ${sys.effects || '...'}<br>
    Статики: ${sys.statics || '...'}
  `;
}

async function fetchSystemInfo(sys){
  const url = `https://api.allorigins.win/get?url=${encodeURIComponent('https://eveok.ru/wh/' + sys.name)}`;
  try{
    const res = await fetch(url);
    const data = await res.json();
    const parser = new DOMParser();
    const doc = parser.parseFromString(data.contents, 'text/html');
    const infoBlock = doc.querySelector('.wh-table'); // адаптировано под eveok.ru
    if(!infoBlock) return;
    // Класс, эффекты, статики
    sys.class = infoBlock.querySelector('td:nth-child(2)')?.textContent || '';
    sys.effects = infoBlock.querySelector('td:nth-child(3)')?.textContent || '';
    sys.statics = infoBlock.querySelector('td:nth-child(4)')?.textContent || '';
    renderSystems();
    if(selectedSystem && selectedSystem.id===sys.id) selectSystem(sys);
  } catch(err){
    console.error('Ошибка получения данных:', err);
  }
}
</script>

</body>
</html>
