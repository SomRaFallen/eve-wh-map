<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EVE — Карта ВХ пилота</title>
  <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:16px}
    input,button{font-size:1rem;padding:8px;margin:4px}
    #map{width:100%;height:420px;border:1px solid #ddd;margin-top:12px}
    #results{margin-top:12px}
    .note{color:#555;font-size:0.9rem}
  </style>
</head>
<body>
  <h2>EVE Online — Карта ВХ пилота</h2>
  <p class="note">Сайт использует <strong>EVE SSO</strong> для авторизации и ESI API для получения недавних киллмейлов пилота.</p>

  <div>
    <button id="authBtn">Авторизоваться через EVE Online</button>
    <button id="logoutBtn" style="display:none">Выйти</button>
  </div>

  <div id="authInfo" class="note"></div>
  <div>
    <input id="charName" placeholder="Имя пилота (например: Vyvanse)" style="width:60%" />
    <button id="searchBtn">Найти ВХ</button>
  </div>

  <div id="status" class="note"></div>
  <div id="map"></div>
  <div id="results"></div>

<script>
// === CONFIGURATION ===
const CLIENT_ID = '5a40c55151c241e3a007f2562fd4e1dd';
const REDIRECT_URI = window.location.origin + window.location.pathname;
const SCOPES = 'esi-killmails.read_killmails.v1 esi-location.read_location.v1';
const ESI_BASE = 'https://esi.evetech.net/latest';
const PROXY_URL = 'https://твoй-render-домен.onrender.com/exchange'; // вставь сюда свой Render URL

// === ELEMENTS ===
const authBtn = document.getElementById('authBtn');
const logoutBtn = document.getElementById('logoutBtn');
const authInfo = document.getElementById('authInfo');
const searchBtn = document.getElementById('searchBtn');
const charNameInput = document.getElementById('charName');
const status = document.getElementById('status');
const results = document.getElementById('results');
const container = document.getElementById('map');

// === AUTH HANDLERS ===
function login(){
  const state = Math.random().toString(36).substring(2);
  const url = `https://login.eveonline.com/v2/oauth/authorize?response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&client_id=${CLIENT_ID}&scope=${encodeURIComponent(SCOPES)}&state=${state}`;
  window.location.href = url;
}

async function exchangeCodeForToken(code){
  const r = await fetch(PROXY_URL, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ code })
  });
  if(!r.ok) throw new Error('Ошибка обмена кода на токен');
  return await r.json();
}

async function getCharacterInfo(token){
  const r = await fetch('https://esi.evetech.net/verify/',{headers:{Authorization:`Bearer ${token}`}});
  if(!r.ok) throw new Error('Ошибка проверки токена');
  return await r.json();
}

function logout(){
  localStorage.removeItem('eve_token');
  localStorage.removeItem('eve_char');
  authInfo.textContent = '';
  logoutBtn.style.display = 'none';
  authBtn.style.display = 'inline-block';
}

async function handleAuth(){
  const params = new URLSearchParams(window.location.search);
  if(params.has('code')){
    const code = params.get('code');
    try{
      const tokenData = await exchangeCodeForToken(code);
      const verify = await getCharacterInfo(tokenData.access_token);
      localStorage.setItem('eve_token', tokenData.access_token);
      localStorage.setItem('eve_char', JSON.stringify(verify));
      authInfo.textContent = `Авторизован: ${verify.CharacterName} (ID: ${verify.CharacterID})`;
      authBtn.style.display = 'none';
      logoutBtn.style.display = 'inline-block';
      window.history.replaceState({}, document.title, window.location.pathname);
    }catch(e){
      console.error(e);
      authInfo.textContent = 'Ошибка авторизации: '+e.message;
    }
  }else{
    const token = localStorage.getItem('eve_token');
    const char = localStorage.getItem('eve_char');
    if(token && char){
      const c = JSON.parse(char);
      authInfo.textContent = `Авторизован: ${c.CharacterName} (ID: ${c.CharacterID})`;
      authBtn.style.display = 'none';
      logoutBtn.style.display = 'inline-block';
    }
  }
}

authBtn.addEventListener('click', login);
logoutBtn.addEventListener('click', logout);
handleAuth();

// === MAP & API ===
function setStatus(t){ status.textContent = t }

async function esiSearchCharacter(name){
  const url = `${ESI_BASE}/search/?categories=character&search=${encodeURIComponent(name)}&strict=true`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('ESI search failed: '+r.status);
  const j = await r.json();
  const chars = j.character || [];
  return chars[0] || null;
}

async function esiGetRecentKillmails(character_id, token){
  const url = `${ESI_BASE}/v1/characters/${character_id}/killmails/recent/`;
  const headers = token ? {Authorization:`Bearer ${token}`} : {};
  const r = await fetch(url,{headers});
  if(!r.ok) throw new Error('ESI recent killmails failed: '+r.status);
  return await r.json();
}

async function esiGetSystem(system_id){
  const url = `${ESI_BASE}/v3/universe/systems/${system_id}/`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('ESI system fetch failed: '+r.status);
  return await r.json();
}

function isWormholeSystemName(name){ return /^J\d+/i.test(name); }

function drawNetwork(nodesArr, edgesArr){
  const nodes = new vis.DataSet(nodesArr.map((n,i)=>({id:i,label:n})));
  const edges = new vis.DataSet(edgesArr.map(e=>({from:e.from,to:e.to})));
  const data = { nodes, edges };
  const options = { physics:{stabilization:true, barnesHut:{gravitationalConstant:-8000}} };
  new vis.Network(container, data, options);
}

searchBtn.addEventListener('click', async ()=>{
  const name = charNameInput.value.trim();
  results.innerHTML = '';
  container.innerHTML = '';
  if(!name){ setStatus('Введите имя персонажа'); return }

  const token = localStorage.getItem('eve_token');

  try{
    setStatus('Поиск персонажа...');
    const charId = await esiSearchCharacter(name);
    if(!charId){ setStatus('Персонаж не найден'); return }
    setStatus('Получаю киллмейлы...');

    const km = await esiGetRecentKillmails(charId, token);
    if(!Array.isArray(km) || km.length===0){ setStatus('Нет данных о киллмейлах'); return }

    const uniq = [...new Set(km.map(x=>x.solar_system_id))];
    setStatus(`Найдено ${uniq.length} систем...`);

    const systems = {};
    const concurrency = 6;
    for(let i=0;i<uniq.length;i+=concurrency){
      const batch = uniq.slice(i,i+concurrency);
      await Promise.all(batch.map(async sid=>{
        try{ const s = await esiGetSystem(sid); systems[sid]=s.name; }catch(e){ systems[sid]='?'; }
      }));
    }

    const wormholeEntries = Object.entries(systems).filter(([id,name])=>isWormholeSystemName(name));
    setStatus(`Найдено ${wormholeEntries.length} ВХ систем.`);

    const nodes = [];
    const edges = [];
    const charNodeLabel = `${name}`;
    nodes.push(charNodeLabel);
    wormholeEntries.forEach(([id,n],idx)=>{ nodes.push(n); edges.push({from:0,to:idx+1}); });
    if(nodes.length>1) drawNetwork(nodes, edges);

    const html = [];
    html.push('<h3>Системы:</h3><ul>');
    for(const [sid,n] of Object.entries(systems)){
      const flag = isWormholeSystemName(n) ? ' — ВХ' : '';
      html.push(`<li>${n}${flag}</li>`);
    }
    html.push('</ul>');
    results.innerHTML = html.join('');
    setStatus('Готово');
  }catch(e){
    console.error(e);
    setStatus('Ошибка: '+e.message);
  }
});
</script>
</body>
</html>
