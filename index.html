<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EVE WH Map (–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è –∫–∞—Ä—Ç–∞)</title>
<script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
<style>
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:16px; }
button { font-size: 1rem; padding:6px; margin:4px; }
#map { width:100%; height:500px; border:1px solid #ddd; margin-top:12px; }
#info { margin-top:12px; }
.note { color:#555; font-size:0.9rem; }
</style>
</head>
<body>
<h2>EVE WH Map ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è –∫–∞—Ä—Ç–∞ wormhole –º–∞—Ä—à—Ä—É—Ç–æ–≤</h2>

<div>
  <button id="authBtn">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ EVE Online</button>
  <button id="logoutBtn" style="display:none">–í—ã–π—Ç–∏</button>
</div>

<div id="authInfo" class="note"></div>

<div>
  <button id="saveBtn" style="display:none">–î–æ–±–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É</button>
  <button id="clearBtn" style="display:none">–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
  <button id="saveMapBtn" style="display:none">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã</button>
  <button id="refreshBtn" style="display:none">–û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç—É</button>
</div>

<div id="map"></div>
<div id="info"></div>

<script>
const CLIENT_ID = '5a40c55151c241e3a007f2562fd4e1dd';
const REDIRECT_URI = 'https://somrafallen.github.io/eve-wh-map/';
const SCOPES = 'esi-location.read_location.v1';

// ‚úÖ —Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä Render
const SERVER = 'https://eve-proxy.onrender.com';

let charData = null;
let historyData = [];
let network = null;

const authBtn = document.getElementById('authBtn');
const logoutBtn = document.getElementById('logoutBtn');
const authInfo = document.getElementById('authInfo');
const saveBtn = document.getElementById('saveBtn');
const clearBtn = document.getElementById('clearBtn');
const saveMapBtn = document.getElementById('saveMapBtn');
const refreshBtn = document.getElementById('refreshBtn');
const infoDiv = document.getElementById('info');
const container = document.getElementById('map');

function login(){
  const state = Math.random().toString(36).substring(2);
  window.location.href = `https://login.eveonline.com/v2/oauth/authorize?response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&client_id=${CLIENT_ID}&scope=${encodeURIComponent(SCOPES)}&state=${state}`;
}

async function exchangeCode(code){
  const r = await fetch(`${SERVER}/exchange`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({code})
  });
  if(!r.ok) throw new Error('–û—à–∏–±–∫–∞ –æ–±–º–µ–Ω–∞ –∫–æ–¥–∞');
  return await r.json();
}

async function getCharacterInfo(token){
  const r = await fetch('https://esi.evetech.net/verify/', {
    headers:{Authorization:`Bearer ${token}` }
  });
  if(!r.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞');
  return await r.json();
}

function logout(){
  localStorage.removeItem('eve_token');
  localStorage.removeItem('eve_char');
  charData = null;
  authInfo.textContent = '';
  authBtn.style.display = 'inline-block';
  logoutBtn.style.display = 'none';
  saveBtn.style.display = 'none';
  clearBtn.style.display = 'none';
  saveMapBtn.style.display = 'none';
  refreshBtn.style.display = 'none';
}

async function handleAuth(){
  const params = new URLSearchParams(window.location.search);
  if(params.has('code')){
    const code = params.get('code');
    try{
      const tokenData = await exchangeCode(code);
      const token = tokenData.access_token;
      charData = await getCharacterInfo(token);
      localStorage.setItem('eve_token', token);
      localStorage.setItem('eve_char', JSON.stringify(charData));
      showAuth();
      window.history.replaceState({}, document.title, window.location.pathname);
    } catch(e){
      console.error(e);
      authInfo.textContent = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: '+e.message;
    }
  } else {
    const savedChar = localStorage.getItem('eve_char');
    if(savedChar){
      charData = JSON.parse(savedChar);
      showAuth();
    }
  }
}

function showAuth(){
  authInfo.textContent = `–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${charData.CharacterName} (ID: ${charData.CharacterID})`;
  authBtn.style.display = 'none';
  logoutBtn.style.display = 'inline-block';
  saveBtn.style.display = 'inline-block';
  clearBtn.style.display = 'inline-block';
  saveMapBtn.style.display = 'inline-block';
  refreshBtn.style.display = 'inline-block';
  loadHistory();
}

async function loadHistory(){
  if(!charData) return;
  const r = await fetch(`${SERVER}/history/${charData.CharacterID}`);
  historyData = await r.json();
  buildMap();
}

function buildMap(){
  const nodes = new vis.DataSet(historyData.map((h,i)=>({id:i,label:h.systemName,title:`–°–∏—Å—Ç–µ–º–∞: ${h.systemName}`})));
  const edges = new vis.DataSet(historyData.map((h,i)=>i>0?{from:i-1,to:i}:null).filter(Boolean));

  const data = {nodes,edges};
  const options = {
    physics:{enabled:true},
    manipulation:{
      enabled:true,
      addEdge: function(edgeData, callback){
        if(edgeData.from === edgeData.to){ alert("–ù–µ–ª—å–∑—è —Å–æ–µ–¥–∏–Ω–∏—Ç—å —Å–∏—Å—Ç–µ–º—É —Å–∞–º—É —Å —Å–æ–±–æ–π"); return; }
        callback(edgeData);
      },
      deleteEdge: true,
      deleteNode: true
    }
  };
  if(network) network.destroy();
  network = new vis.Network(container, data, options);

  network.on('selectNode', params=>{
    const node = historyData[params.nodes[0]];
    infoDiv.textContent = `–°–∏—Å—Ç–µ–º–∞: ${node.systemName} | –í—Ä–µ–º—è: ${node.timestamp}`;
  });

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –æ–±—ä–µ–∫—Ç–∞–º
  window.networkNodes = nodes;
  window.networkEdges = edges;
}

async function saveCurrentSystem(){
  if(!charData) return alert('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
  const systemName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã:');
  if(!systemName) return;
  const systemID = Math.floor(Math.random()*100000);
  await fetch(`${SERVER}/location`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({characterID:charData.CharacterID, systemID, systemName})
  });
  await loadHistory();
}

async function clearHistory(){
  if(!charData) return alert('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
  await fetch(`${SERVER}/history/${charData.CharacterID}`, {method:'DELETE'});
  await loadHistory();
}

// üîπ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
async function saveMapChanges(){
  if(!charData) return alert('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
  const nodes = window.networkNodes.get();
  const edges = window.networkEdges.get();
  const payload = {nodes, edges};
  await fetch(`${SERVER}/history/${charData.CharacterID}`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  alert('–ö–∞—Ä—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!');
}

authBtn.addEventListener('click', login);
logoutBtn.addEventListener('click', logout);
saveBtn.addEventListener('click', saveCurrentSystem);
clearBtn.addEventListener('click', clearHistory);
saveMapBtn.addEventListener('click', saveMapChanges);
refreshBtn.addEventListener('click', loadHistory);

handleAuth();
</script>
</body>
</html>
