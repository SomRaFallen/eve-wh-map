<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EVE WH Map</title>
<script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:16px}
button{font-size:1rem;padding:6px;margin:4px}
#map{width:100%;height:480px;border:1px solid #ddd;margin-top:12px}
#results{margin-top:12px}
#zkbKills{margin-top:12px;border:1px solid #ddd;padding:8px;height:220px;overflow:auto;background:#f9f9f9}
.note{color:#555;font-size:0.9rem}
.copyBtn{margin-left:6px;padding:2px 4px;font-size:0.8rem;cursor:pointer}
</style>
</head>
<body>
<h2>EVE Online — Карта перемещений ВХ</h2>
<p class="note">Карта перемещений персонажа через вормхолы. Последние киллмейлы берутся с ZKillboard.</p>

<div>
<button id="authBtn">Авторизоваться через EVE Online</button>
<button id="logoutBtn" style="display:none">Выйти</button>
</div>
<div id="authInfo" class="note"></div>
<div>
<button id="buildMapBtn" style="display:none">Построить карту ВХ</button>
<button id="savePathBtn" style="display:none">Сохранить путь</button>
<button id="clearPathBtn" style="display:none">Очистить путь</button>
</div>

<div id="status" class="note"></div>
<div id="map"></div>
<div id="results"></div>
<div id="zkbKills"><strong>Последние киллмейлы (ZKB):</strong><br></div>

<script>
const CLIENT_ID = '5a40c55151c241e3a007f2562fd4e1dd';
const REDIRECT_URI = window.location.origin + window.location.pathname;
const SCOPES = 'esi-location.read_location.v1';
const PROXY_URL = '/exchange';
const RENDER_SERVER = '';

const authBtn = document.getElementById('authBtn');
const logoutBtn = document.getElementById('logoutBtn');
const buildMapBtn = document.getElementById('buildMapBtn');
const savePathBtn = document.getElementById('savePathBtn');
const clearPathBtn = document.getElementById('clearPathBtn');
const authInfo = document.getElementById('authInfo');
const status = document.getElementById('status');
const results = document.getElementById('results');
const zkbKillsDiv = document.getElementById('zkbKills');
const container = document.getElementById('map');

let historyWH = [];

function login(){
    const state = Math.random().toString(36).substring(2);
    const url = `https://login.eveonline.com/v2/oauth/authorize?response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&client_id=${CLIENT_ID}&scope=${encodeURIComponent(SCOPES)}&state=${state}`;
    window.location.href = url;
}

async function exchangeCodeForToken(code){
    const r = await fetch(PROXY_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json; charset=utf-8'},
        body: JSON.stringify({ code })
    });
    if(!r.ok) throw new Error('Ошибка обмена кода на токен');
    return await r.json();
}

async function getCharacterInfo(token){
    const r = await fetch('https://esi.evetech.net/verify/',{
        headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/json; charset=utf-8'}
    });
    if(!r.ok) throw new Error('Ошибка проверки токена');
    return await r.json();
}

function logout(){
    localStorage.removeItem('eve_token');
    localStorage.removeItem('eve_char');
    authInfo.textContent = '';
    authBtn.style.display = 'inline-block';
    logoutBtn.style.display = 'none';
    buildMapBtn.style.display = 'none';
    savePathBtn.style.display = 'none';
    clearPathBtn.style.display = 'none';
}

async function handleAuth(){
    const params = new URLSearchParams(window.location.search);
    let char, token;

    if(params.has('code')){
        const code = params.get('code');
        try{
            const tokenData = await exchangeCodeForToken(code);
            token = tokenData.access_token;
            const verify = await getCharacterInfo(token);
            char = verify;
            localStorage.setItem('eve_token', token);
            localStorage.setItem('eve_char', JSON.stringify(char));
            authInfo.textContent = `Авторизован: ${char.CharacterName} (ID: ${char.CharacterID})`;
            authBtn.style.display = 'none';
            logoutBtn.style.display = 'inline-block';
            buildMapBtn.style.display = 'inline-block';
            savePathBtn.style.display = 'inline-block';
            clearPathBtn.style.display = 'inline-block';
            window.history.replaceState({}, document.title, window.location.pathname);
        }catch(e){
            console.error(e);
            authInfo.textContent = 'Ошибка авторизации: '+e.message;
        }
    } else {
        token = localStorage.getItem('eve_token');
        const charData = localStorage.getItem('eve_char');
        if(token && charData){
            char = JSON.parse(charData);
            authInfo.textContent = `Авторизован: ${char.CharacterName} (ID: ${char.CharacterID})`;
            authBtn.style.display = 'none';
            logoutBtn.style.display = 'inline-block';
            buildMapBtn.style.display = 'inline-block';
            savePathBtn.style.display = 'inline-block';
            clearPathBtn.style.display = 'inline-block';
        }
    }
}

authBtn.addEventListener('click', login);
logoutBtn.addEventListener('click', logout);
handleAuth();
</script>
</body>
</html>
